# Environment variables
# DB_USER
# DB_PASSWORD
# DB_NAME
# LITELLM_MASTER_KEY
# LITELLM_HOST
# CLI_PROXY_API_HOST
# CLI_PROXY_API_2_HOST

volumes:
  cli_proxy_api_auth_data:
  cli_proxy_api_config_data:
  cli_proxy_api_2_auth_data:
  cli_proxy_api_2_config_data:
  db_data:
  prometheus_data:

x-common-healthcheck: &common-healthcheck
  interval: 30s       # Perform health check every 30 seconds
  timeout: 10s        # Health check command times out after 10 seconds
  retries: 3          # Retry up to 3 times if health check fails

x-common-deploy: &common-deploy
  replicas: 1
  update_config:
    parallelism: 1
    delay: 10s
    order: start-first
    failure_action: rollback
  rollback_config:
    parallelism: 1
    delay: 10s
    order: stop-first

x-cli-proxy-api: &cli-proxy-api
  image: eceasy/cli-proxy-api:v6.6.100
  command:
    - sh
    - -c
    - |
      if [ ! -f /CLIProxyAPI/config/config.yaml ]; then
        cp /CLIProxyAPI/config_ro/config.yaml /CLIProxyAPI/config/config.yaml
      fi
      exec ./CLIProxyAPI --config /CLIProxyAPI/config/config.yaml
  environment:
    TZ: ${TZ:-UTC}
  healthcheck:
    <<: *common-healthcheck
    test: ["CMD-SHELL", "wget -q --spider http://localhost:8317/ || exit 1"]
    start_period: 10s
  networks:
    - internal
    - public

services:
  cli-proxy-api:
    <<: *cli-proxy-api
    volumes:
      - cli_proxy_api_config_data:/CLIProxyAPI/config
      - cli_proxy_api_auth_data:/CLIProxyAPI/auth
    configs:
      - source: cli_proxy_api_config_yaml
        target: /CLIProxyAPI/config_ro/config.yaml
    deploy:
      <<: *common-deploy
      labels:
        - traefik.enable=true
        - traefik.http.routers.cli-proxy-api.rule=Host(`${CLI_PROXY_API_HOST}`)
        - traefik.http.routers.cli-proxy-api.entrypoints=websecure
        - traefik.http.routers.cli-proxy-api.tls.certresolver=${LETSENCRYPT_RESOLVER:-le}
        - traefik.http.services.cli-proxy-api.loadbalancer.server.port=8317

  cli-proxy-api-2:
    <<: *cli-proxy-api
    volumes:
      - cli_proxy_api_2_config_data:/CLIProxyAPI/config
      - cli_proxy_api_2_auth_data:/CLIProxyAPI/auth
    configs:
      - source: cli_proxy_api_2_config_yaml
        target: /CLIProxyAPI/config_ro/config.yaml
    deploy:
      <<: *common-deploy
      labels:
        - traefik.enable=true
        - traefik.http.routers.cli-proxy-api-2.rule=Host(`${CLI_PROXY_API_2_HOST}`)
        - traefik.http.routers.cli-proxy-api-2.entrypoints=websecure
        - traefik.http.routers.cli-proxy-api-2.tls.certresolver=${LETSENCRYPT_RESOLVER:-le}
        - traefik.http.services.cli-proxy-api-2.loadbalancer.server.port=8317

  db:
    image: postgres:18.1-alpine3.23
    environment:
      POSTGRES_USER: ${DB_USER:-app}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-app_db_PW@2018}
      POSTGRES_DB: ${DB_NAME:-app}
    volumes:
      - db_data:/var/lib/postgresql/data
    networks:
      - internal
    healthcheck:
      <<: *common-healthcheck
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER:-app} -d ${DB_NAME:-app} -p 5432"]

  litellm:
    image: ghcr.io/berriai/litellm-database:main-v1.80.11-stable
    deploy:
      <<: *common-deploy
      labels:
        - traefik.enable=true
        - traefik.http.routers.litellm.rule=Host(`${LITELLM_HOST}`)
        - traefik.http.routers.litellm.entrypoints=websecure
        - traefik.http.routers.litellm.tls.certresolver=${LETSENCRYPT_RESOLVER:-le}
        - traefik.http.services.litellm.loadbalancer.server.port=4000
    environment:
      DATABASE_URL: "postgresql://${DB_USER:-app}:${DB_PASSWORD:-app_db_PW@2018}@db:5432/${DB_NAME:-app}"
      STORE_MODEL_IN_DB: "True" # allows adding models to proxy via UI
      LITELLM_MASTER_KEY: ${LITELLM_MASTER_KEY:-litellm_master_key}
    healthcheck:  # Defines the health check configuration for the container
      <<: *common-healthcheck
      test:
        - CMD-SHELL
        - python3 -c "import urllib.request; urllib.request.urlopen('http://localhost:4000/health/liveliness')"  # Command to execute for health check
      start_period: 40s   # Wait 40 seconds after container start before beginning health checks
    networks:
      - internal
      - public

  prometheus:
    image: prom/prometheus:v3.9.1
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.path=/prometheus"
      - "--storage.tsdb.retention.time=15d"
    volumes:
      - prometheus_data:/prometheus
    configs:
      - source: prometheus_yml
        target: /etc/prometheus/prometheus.yml
    networks:
      - internal

configs:
  cli_proxy_api_config_yaml:
    name: ${CLI_PROXY_API_CONFIG_NAME:-cli_proxy_api_config_yaml}
    external: true
  cli_proxy_api_2_config_yaml:
    name: ${CLI_PROXY_API_2_CONFIG_NAME:-cli_proxy_api_2_config_yaml}
    external: true
  prometheus_yml:
    name: ${PROMETHEUS_CONFIG_NAME:-prometheus_yml}
    external: true

networks:
  internal:
    driver: overlay
    internal: true
  public:
    name: ${PUBLIC_NETWORK:-public}
    external: true
